
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Description of the match template program">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../refine_template/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>The Match Template Program - Leopard-EM: Two-Dimensional Template Matching in Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-match-template-program" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-header__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Leopard-EM: Two-Dimensional Template Matching in Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              The Match Template Program
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-nav__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Leopard-EM: Two-Dimensional Template Matching in Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Programs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Match Template
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Match Template
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-level-micrograph-and-template-paths" class="md-nav__link">
    <span class="md-ellipsis">
      Top-level micrograph and template paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-result-files" class="md-nav__link">
    <span class="md-ellipsis">
      Output result files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optics-group-for-micrograph-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Optics group for micrograph parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defocus-search-space-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Defocus search space configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orientation-search-space-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Orientation search space configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-the-pre-processing-filters" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring the pre-processing filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-gpus-for-a-match-template-run" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring GPUs for a match template run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-match-template-program" class="md-nav__link">
    <span class="md-ellipsis">
      Running the match template program
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running the match template program">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#match-template-output-files" class="md-nav__link">
    <span class="md-ellipsis">
      Match template output files
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mathematical-description" class="md-nav__link">
    <span class="md-ellipsis">
      Mathematical description
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../refine_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Refine Template
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data_formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Program Output Formats
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/basic_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Template Matching Configurations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#top-level-micrograph-and-template-paths" class="md-nav__link">
    <span class="md-ellipsis">
      Top-level micrograph and template paths
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#output-result-files" class="md-nav__link">
    <span class="md-ellipsis">
      Output result files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optics-group-for-micrograph-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Optics group for micrograph parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defocus-search-space-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Defocus search space configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orientation-search-space-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Orientation search space configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-the-pre-processing-filters" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring the pre-processing filters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-gpus-for-a-match-template-run" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring GPUs for a match template run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-match-template-program" class="md-nav__link">
    <span class="md-ellipsis">
      Running the match template program
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running the match template program">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#match-template-output-files" class="md-nav__link">
    <span class="md-ellipsis">
      Match template output files
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mathematical-description" class="md-nav__link">
    <span class="md-ellipsis">
      Mathematical description
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="the-match-template-program">The match template program</h1>
<p>The match template program takes in a micrograph and a simulated reference structure along with search parameters to find locations in the image which agree with expected 2D projections of this reference structure.
Notably, the match template program simultaneously find the orientations of these particles as well as the depth of the particle within the sample.</p>
<h2 id="configuration-options">Configuration options</h2>
<p>A default config file for the match template program is available <a href="https://raw.githubusercontent.com/Lucaslab-Berkeley/Leopard-EM/refs/heads/main/match_template_example_config.yaml">here on the GitHub page</a>.
This file is separated into multiple "blocks" each configuring distinct portions of the program discussed briefly below.
Defining and exporting these configurations in terms of Python objects is detailed in <a href="../../examples/basic_configuration/">Match Template Configuration</a></p>
<h3 id="top-level-micrograph-and-template-paths">Top-level micrograph and template paths</h3>
<p>The first two fields in the configuration are paths to the 3D reference template and 2D micrograph saved as MRC files.
Update these paths based on your system/experiment.</p>
<pre><code class="language-yaml">template_volume_path: /some/path/to/template.mrc
micrograph_path:      /some/path/to/micrograph.mrc
</code></pre>
<p>Note the reference template should be simulated under the same conditions as the experimental micrograph (e.g. total exposure).
A 3D volume can be simulated from a PDB structure using the <a href="https://github.com/teamtomo/ttsim3d">TeamTomo ttsim3d</a> Python package.</p>
<h3 id="output-result-files">Output result files</h3>
<p>The next block is the <code>match_template_result</code> configuration which defined the output paths for the match template program results.
Note that these paths need to be writable by the user executing the program, and the <code>match_template_result</code> needs to be set to <code>true</code> if you are overwriting pre-existing result files.</p>
<pre><code class="language-yaml">match_template_result:
  allow_file_overwrite: true
  mip_path:                   /some/path/to/output_mip.mrc
  scaled_mip_path:            /some/path/to/output_scaled_mip.mrc
  orientation_psi_path:       /some/path/to/output_orientation_psi.mrc
  orientation_theta_path:     /some/path/to/output_orientation_theta.mrc
  orientation_phi_path:       /some/path/to/output_orientation_phi.mrc
  relative_defocus_path:      /some/path/to/output_relative_defocus.mrc
  correlation_average_path:   /some/path/to/output_correlation_average.mrc
  correlation_variance_path:  /some/path/to/output_correlation_variance.mrc
</code></pre>
<p>Results are saved as MRC files with positions <script type="math/tex"> (x, y) </script> corresponding to positions in the image.
See <a href="../../data_formats/">Data Formats</a> for more information.</p>
<h3 id="optics-group-for-micrograph-parameters">Optics group for micrograph parameters</h3>
<p>Constructing the projective filters requires knowledge of what microscope parameters were used to collect the micrograph, namely the defocus of the image.
These microscope parameters are collected under the <code>optics_group</code> block with the most common parameters listed below.</p>
<pre><code class="language-yaml">optics_group:
  label: some_label
  voltage: 300.0
  pixel_size: 1.06   # in Angstroms
  defocus_u: 5200.0  # in Angstroms
  defocus_v: 4950.0  # in Angstroms
  astigmatism_angle: 25.0  # in degrees
  spherical_aberration: 2.7  # in millimeters
  amplitude_contrast_ratio: 0.07
  ctf_B_factor: 60.0  # in Angstroms^2
</code></pre>
<p>Note the <code>label</code> field is currently unused, but could be integrated in the future to differentiate between multiple micrographs and/or refined optical parameters.</p>
<h3 id="defocus-search-space-configuration">Defocus search space configuration</h3>
<p>Defining the defocus search space is configured using the <code>defocus_search_config</code> block which defines the minimum, maximum, and step size of defocus values searched over in units of Angstroms.</p>
<pre><code class="language-yaml">defocus_search_config:
  defocus_max:  1200.0  # in Angstroms, relative to the defocus_u and defocus_v values
  defocus_min: -1200.0  # in Angstroms, relative to the defocus_u and defocus_v values
  defocus_step: 200.0   # in Angstroms
  enabled: true
</code></pre>
<p>Note that these defocus values are relative to <code>optics_group.defocus_u</code> and <code>optics_group.defocus_v</code> values.
Also, the defocus search can be turned off by changing <code>enabled: true</code> to <code>enabled: false</code>.</p>
<h3 id="orientation-search-space-configuration">Orientation search space configuration</h3>
<p>Defining the orientation search space is configured using the <code>orientation_search_config</code> block which defines the orientation sampling parameters.
We find that an in-plane step size of 1.5 degrees and out-of-plane step size of 2.5 degrees with a uniform base grid works well when searching for ribosomes, but other sized structures may need these parameters adjusted.
There is also the <code>"heapix"</code> option for the <code>base_grid_method</code> field which uses the <a href="https://healpix.jpl.nasa.gov">HEALPix</a> discretization of the sphere to sample orientation space.
Also, the underlying <a href="https://github.com/teamtomo/torch-so3">torch-so3 package</a> supports multiple particles symmetries but we are working to port that into the Leopard-EM package; currently only C1 symmetry is used.</p>
<pre><code class="language-yaml">orientation_search_config:
  base_grid_method: uniform
  in_plane_step: 1.5      # in degrees
  out_of_plane_step: 2.5  # in degrees

</code></pre>
<h3 id="configuring-the-pre-processing-filters">Configuring the pre-processing filters</h3>
<p>We also include some configuration options for pre-processing Fourier filters applied to both the image and template.
Below, we briefly discuss the parameter choices for the whitening and band-pass filters -- the two most common filter types; there are two additional pre-processing filters (phase-randomization and arbitrary curve) discussed <a href="../../examples/basic_configuration/">here</a>.
In most cases, the default values should suffice, but nevertheless the knobs to tweak how calculations are performed are included for completeness' sake.</p>
<p>The whitening filter, with parameters defined under <code>preprocessing_filters.whitening_filter</code>, flattens the 1D power spectrum of the image so each frequency component contributes equally to the cross-corelation; the same filter is applied to template projections.
The whitening filter is enabled by default and necessary to compensate for the the strong low-frequency components of <em>in situ</em> cryo-EM images,<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> but the filter can be disabled by changing <code>enabled: true</code> to <code>enabled: false</code>.
Changing the <code>do_power_spectrum</code> to <code>false</code> will calculate the whitening filter based on the amplitude spectrum instead of the power spectrum.
The <code>whitening_filter.max_freq</code> field defines the maximum frequency considered (in terms of Nyquist) when calculating the whitening filter; the default of <code>0.5</code> should perform well in most cases.
Similarly, keeping the default <code>num_freq_bins: null</code> will choose the number of frequency bins automatically based on input image shape.
Values between 500-2,000 are generally good.</p>
<p>Bandpass filtering is disabled by default but can be turned on by changing <code>enabled: false</code> to <code>enabled: true</code>.
Note that the <code>high_freq_cutoff</code> and <code>low_freq_cutoff</code> fields are both defined in terms of the Nyquist frequency with values of <code>null</code> corresponding to no cutoff.
For example, <code>high_freq_cutoff: 0.5</code> and <code>low_freq_cutoff: null</code> would correspond to a low-pass filter to the Nyquist frequency of the image.
Filtering to a specific resolution in terms of Angstroms means doing some basic math to populate these fields.</p>
<pre><code class="language-yaml">preprocessing_filters:
  whitening_filter:
    enabled: true
    do_power_spectrum: true
    max_freq: 0.5  # In terms of Nyquist frequency
    num_freq_bins: null
  bandpass_filter:
    enabled: false
    falloff: null
    high_freq_cutoff: null  # Both high/low in terms of Nyquist frequency
    low_freq_cutoff: null   # e.g. low-pass to 3 Å @ 1.06 Å/px would be 1.06/3 = 0.353
</code></pre>
<h3 id="configuring-gpus-for-a-match-template-run">Configuring GPUs for a match template run</h3>
<p>The final block of the match template configuration file is used to choose which GPUs will run on.
The <code>num_cpus</code> field can currently be ignored and just set to <code>1</code>.
The <code>gpu_ids</code> field is a list of integers defining which GPU device index(s) the program will target.
Configuring the search to be run on the first two GPUs is shown below.</p>
<pre><code class="language-yaml">computational_config:
  gpu_ids:
  - 0
  - 1
  num_cpus: 1
</code></pre>
<h2 id="running-the-match-template-program">Running the match template program</h2>
<p>Once you've configured a YAML file, running the match template program is fairly simple.
We have an example script, <a href="https://github.com/Lucaslab-Berkeley/Leopard-EM/blob/main/src/programs/match_template.py"><code>src/programs/match_template.py</code></a>, which processes a single micrograph against a single reference template.
Again, you will need to simulate a 3D electron scattering potential from a PDB file (for example with the <a href="https://github.com/teamtomo/ttsim3d">ttsim3d</a> package) before running the script.</p>
<h3 id="match-template-output-files">Match template output files</h3>
<p>The above script will output the statistics maps over the image for the search as well as a Pandas DataFrame with compacted information on found particles.
These data can be passed onto downstream analysis, for example the refine template program.
More detail about these data is on the <a href="../../data_formats/">data formats page</a>.</p>
<h2 id="mathematical-description">Mathematical description</h2>
<p>Described succinctly using mathematics, the match template constructs the orientational search space, <script type="math/tex"> \mathbf{R} = \{ R_1, R_2, \dots, R_n\} </script>, and relative defocus search space, <script type="math/tex"> \mathbf{Q} = \{ \Delta f_1, \Delta f_2, \dots, \Delta f_m\} </script>, to generate the CTF-convolved projections searched over:</p>
<p>
<script type="math/tex; mode=display">
\mathbf{P} = \mathbf{Q} \times \mathbf{R} = \{ p_{11}, \dots, p_{n1}, \dots, p_{nm} \}
</script>
</p>
<p>The "best" projection, based on cross-correlation with the cryo-EM image <script type="math/tex"> I </script>, is found,</p>
<p>
<script type="math/tex; mode=display">
\begin{align}
    \tilde{p}_{ij} = \argmax_{p \in \mathbf{P}} \left(p \cdot I \right)
\end{align}
</script>
</p>
<p>where the indexes <script type="math/tex"> i </script> and <script type="math/tex"> j </script> correspond to the orientation and relative defocus which generated the "best" projection.
Orientations of the best projection are returned as Euler angles <script type="math/tex"> (\phi, \theta, \psi) </script> in the ZYZ format.
Note that this search is done simultaneous for all positions,  <script type="math/tex"> (x, y) </script> within the image using the convolution theorem, but here we focus on a single location in the image.
The match template program also returns the Maximum Intensity Projection (MIP) which is the cross-correlation score of the best projection as well as a z-score on a per-pixel level.</p>
<p>
<script type="math/tex; mode=display">
\begin{align}
    \text{MIP} &= \tilde{p}_{ij} \cdot I \\[6pt]
    \text{z-score} &= \frac{
        \text{MIP} - \mu(\{ p \cdot I : \forall p \in \mathbf{P} \})}
        {\sigma(\{ p \cdot I : \forall p \in \mathbf{P} \})}
\end{align}
</script>
</p>
<p>There are other steps, namely Fourier filtering, which are discussed further in the theory portion of the documentation.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>J Peter Rickgauer, Nikolaus Grigorieff, Winfried Denk (2017) Single-protein detection in crowded molecular environments in cryo-EM images eLife 6:e25648, https://doi.org/10.7554/eLife.25648&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>